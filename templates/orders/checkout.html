{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - Drishthi Printing{% endblock %}

{% block content %}
<div class="pt-32 min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Progress Steps -->
        <div class="mb-8">
            <div class="flex items-center justify-center space-x-4">
                <div class="flex items-center text-blue-600">
                    <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-semibold">1</div>
                    <span class="ml-2 font-medium">Cart</span>
                </div>
                <div class="w-8 h-px bg-blue-600"></div>
                <div class="flex items-center text-blue-600">
                    <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-semibold">2</div>
                    <span class="ml-2 font-medium">Checkout</span>
                </div>
                <div class="w-8 h-px bg-gray-300"></div>
                <div class="flex items-center text-gray-400">
                    <div class="w-8 h-8 bg-gray-300 text-gray-500 rounded-full flex items-center justify-center text-sm font-semibold">3</div>
                    <span class="ml-2 font-medium">Payment</span>
                </div>
                <div class="w-8 h-px bg-gray-300"></div>
                <div class="flex items-center text-gray-400">
                    <div class="w-8 h-8 bg-gray-300 text-gray-500 rounded-full flex items-center justify-center text-sm font-semibold">4</div>
                    <span class="ml-2 font-medium">Confirmation</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Checkout Form -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Shipping Information -->
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">Shipping Information</h2>
                    
                    <form id="checkoutForm">
                        {% csrf_token %}
                        <div class="space-y-6">
                            <!-- Contact Information -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="first_name" class="block text-sm font-medium text-gray-700 mb-2">
                                        First Name <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="first_name" name="first_name" required
                                           value="{% if user.is_authenticated %}{{ user.first_name }}{% endif %}"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="last_name" class="block text-sm font-medium text-gray-700 mb-2">
                                        Last Name <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="last_name" name="last_name" required
                                           value="{% if user.is_authenticated %}{{ user.last_name }}{% endif %}"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                                        Email Address <span class="text-red-500">*</span>
                                    </label>
                                    <input type="email" id="email" name="email" required
                                           value="{% if user.is_authenticated %}{{ user.email }}{% endif %}"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
                                        Phone Number <span class="text-red-500">*</span>
                                    </label>
                                    <input type="tel" id="phone" name="phone" required
                                           value="{% if user.is_authenticated %}{{ user.phone }}{% endif %}"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>

                            <!-- Saved Addresses -->
                            {% if user.is_authenticated and addresses %}
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-3">Choose Saved Address</label>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    {% for address in addresses %}
                                    <div class="relative">
                                        <input type="radio" id="address_{{ address.id }}" name="saved_address" value="{{ address.id }}"
                                               class="sr-only" onchange="fillAddressForm({{ address.id }})">
                                        <label for="address_{{ address.id }}" 
                                               class="block p-4 border border-gray-300 rounded-lg cursor-pointer hover:border-blue-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                                            {% if address.is_default %}
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mb-2">
                                                    Default
                                                </span>
                                            {% endif %}
                                            <div class="font-medium text-gray-900">{{ address.full_name }}</div>
                                            <div class="text-sm text-gray-600 mt-1">
                                                {{ address.address_line_1 }}
                                                {% if address.address_line_2 %}, {{ address.address_line_2 }}{% endif %}
                                            </div>
                                            <div class="text-sm text-gray-600">
                                                {{ address.city }}, {{ address.state }} {{ address.pincode }}
                                            </div>
                                            <div class="text-sm text-gray-600">{{ address.phone }}</div>
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="text-center">
                                    <button type="button" onclick="showNewAddressForm()"
                                            class="text-blue-600 hover:text-blue-800 font-medium text-sm">
                                        + Use a different address
                                    </button>
                                </div>
                            </div>
                            {% endif %}

                            <!-- New Address Form -->
                            <div id="newAddressForm" class="space-y-6 {% if user.is_authenticated and addresses %}hidden{% endif %}">
                                <div>
                                    <label for="address_line_1" class="block text-sm font-medium text-gray-700 mb-2">
                                        Address Line 1 <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="address_line_1" name="address_line_1" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                           placeholder="House/Building number, street name">
                                </div>

                                <div>
                                    <label for="address_line_2" class="block text-sm font-medium text-gray-700 mb-2">
                                        Address Line 2
                                    </label>
                                    <input type="text" id="address_line_2" name="address_line_2"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                           placeholder="Apartment, suite, unit, building, floor, etc.">
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <label for="city" class="block text-sm font-medium text-gray-700 mb-2">
                                            City <span class="text-red-500">*</span>
                                        </label>
                                        <input type="text" id="city" name="city" required
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label for="state" class="block text-sm font-medium text-gray-700 mb-2">
                                            State <span class="text-red-500">*</span>
                                        </label>
                                        <select id="state" name="state" required
                                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="">Select State</option>
                                            <option value="Haryana">Haryana</option>
                                            <option value="Delhi">Delhi</option>
                                            <option value="Punjab">Punjab</option>
                                            <option value="Uttar Pradesh">Uttar Pradesh</option>
                                            <option value="Rajasthan">Rajasthan</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="pincode" class="block text-sm font-medium text-gray-700 mb-2">
                                            Pincode <span class="text-red-500">*</span>
                                        </label>
                                        <input type="text" id="pincode" name="pincode" required pattern="[0-9]{6}"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                </div>

                                {% if user.is_authenticated %}
                                <div class="flex items-center">
                                    <input type="checkbox" id="save_address" name="save_address" 
                                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label for="save_address" class="ml-2 block text-sm text-gray-700">
                                        Save this address for future orders
                                    </label>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Delivery Options -->
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">Delivery Options</h2>
                    
                    <div class="space-y-4">
                        <label class="flex items-center justify-between p-4 border border-gray-300 rounded-lg cursor-pointer hover:border-blue-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                            <div class="flex items-center">
                                <input type="radio" name="delivery_option" value="standard" checked class="sr-only">
                                <div class="mr-4">
                                    <i class="fas fa-truck text-blue-600 text-xl"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900">Standard Delivery</div>
                                    <div class="text-sm text-gray-600">5-7 business days</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-gray-900">Free</div>
                                <div class="text-sm text-gray-500">On orders above ₹500</div>
                            </div>
                        </label>

                        <label class="flex items-center justify-between p-4 border border-gray-300 rounded-lg cursor-pointer hover:border-blue-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                            <div class="flex items-center">
                                <input type="radio" name="delivery_option" value="express" class="sr-only">
                                <div class="mr-4">
                                    <i class="fas fa-bolt text-green-600 text-xl"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900">Express Delivery</div>
                                    <div class="text-sm text-gray-600">2-3 business days</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-gray-900">₹150</div>
                                <div class="text-sm text-gray-500">Additional charges</div>
                            </div>
                        </label>

                        <label class="flex items-center justify-between p-4 border border-gray-300 rounded-lg cursor-pointer hover:border-blue-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                            <div class="flex items-center">
                                <input type="radio" name="delivery_option" value="pickup" class="sr-only">
                                <div class="mr-4">
                                    <i class="fas fa-store text-purple-600 text-xl"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900">Store Pickup</div>
                                    <div class="text-sm text-gray-600">Pick up from our store</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-gray-900">Free</div>
                                <div class="text-sm text-gray-500">Ready in 3-5 days</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Special Instructions -->
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">Special Instructions</h2>
                    <textarea name="special_instructions" rows="4" 
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Any special delivery instructions or requirements..."></textarea>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="space-y-8">
                <!-- Cart Items -->
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">Order Summary</h2>
                    
                    <div class="space-y-4">
                        {% for item in cart_items %}
                        <div class="flex items-center space-x-4 pb-4 border-b border-gray-200 last:border-b-0">
                            <div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                                {% if item.product.images.first %}
                                    <img src="{{ item.product.images.first.image.url }}" alt="{{ item.product.name }}" 
                                         class="w-full h-full object-cover">
                                {% else %}
                                    <img src="{% static 'images/service-design-services.svg' %}" alt="{{ item.product.name }}" 
                                         class="w-full h-full object-cover">
                                {% endif %}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-medium text-gray-900 truncate">{{ item.product.name }}</h3>
                                <div class="text-sm text-gray-600 mt-1">
                                    {% if item.product_options %}
                                        {% for key, value in item.product_options.items %}
                                            {{ key|title }}: {{ value }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                <div class="text-sm text-gray-600 mt-1">Qty: {{ item.quantity }}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-gray-900">₹{{ item.total_price }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Price Breakdown -->
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Price Details</h3>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between text-gray-600">
                            <span>Subtotal</span>
                            <span id="subtotal">₹{{ cart_total }}</span>
                        </div>
                        
                        <div class="flex justify-between text-gray-600">
                            <span>Delivery Charges</span>
                            <span id="deliveryCharges">Free</span>
                        </div>
                        
                        <div class="flex justify-between text-gray-600">
                            <span>GST (18%)</span>
                            <span id="gst">₹{{ cart_total|floatformat:2|add:0|mul:0.18 }}</span>
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="flex justify-between text-lg font-semibold text-gray-900">
                            <span>Total Amount</span>
                            <span id="totalAmount">₹{{ cart_total|add:cart_total|mul:0.18 }}</span>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <button type="submit" form="checkoutForm"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                            Proceed to Payment
                        </button>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <a href="{% url 'orders:cart' %}" class="text-blue-600 hover:text-blue-800 font-medium text-sm">
                            ← Back to Cart
                        </a>
                    </div>
                </div>

                <!-- Security & Trust -->
                <div class="bg-green-50 border border-green-200 rounded-xl p-6">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-shield-alt text-green-600 text-xl mr-3"></i>
                        <h3 class="font-semibold text-green-900">Secure Checkout</h3>
                    </div>
                    <ul class="text-sm text-green-800 space-y-1">
                        <li class="flex items-center"><i class="fas fa-check mr-2"></i>SSL encrypted payment</li>
                        <li class="flex items-center"><i class="fas fa-check mr-2"></i>No hidden charges</li>
                        <li class="flex items-center"><i class="fas fa-check mr-2"></i>100% secure transactions</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Address data for prefilling
const addresses = {
    {% for address in addresses %}
    {{ address.id }}: {
        'full_name': '{{ address.full_name }}',
        'address_line_1': '{{ address.address_line_1 }}',
        'address_line_2': '{{ address.address_line_2 }}',
        'city': '{{ address.city }}',
        'state': '{{ address.state }}',
        'pincode': '{{ address.pincode }}',
        'phone': '{{ address.phone }}'
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};

function fillAddressForm(addressId) {
    const address = addresses[addressId];
    if (address) {
        document.getElementById('first_name').value = address.full_name.split(' ')[0] || '';
        document.getElementById('last_name').value = address.full_name.split(' ').slice(1).join(' ') || '';
        document.getElementById('address_line_1').value = address.address_line_1;
        document.getElementById('address_line_2').value = address.address_line_2;
        document.getElementById('city').value = address.city;
        document.getElementById('state').value = address.state;
        document.getElementById('pincode').value = address.pincode;
        document.getElementById('phone').value = address.phone;
    }
    
    // Hide new address form
    document.getElementById('newAddressForm').classList.add('hidden');
}

function showNewAddressForm() {
    document.getElementById('newAddressForm').classList.remove('hidden');
    
    // Uncheck saved addresses
    document.querySelectorAll('input[name="saved_address"]').forEach(input => {
        input.checked = false;
    });
    
    // Clear form
    const form = document.getElementById('checkoutForm');
    form.querySelectorAll('#newAddressForm input, #newAddressForm select').forEach(input => {
        if (input.type !== 'checkbox') {
            input.value = '';
        }
    });
}

// Delivery option change handler
document.querySelectorAll('input[name="delivery_option"]').forEach(input => {
    input.addEventListener('change', function() {
        updateTotalAmount();
    });
});

function updateTotalAmount() {
    const subtotal = parseFloat('{{ cart_total }}');
    const gstRate = 0.18;
    let deliveryCharges = 0;
    
    const selectedDelivery = document.querySelector('input[name="delivery_option"]:checked').value;
    if (selectedDelivery === 'express') {
        deliveryCharges = 150;
    }
    
    const gst = (subtotal + deliveryCharges) * gstRate;
    const total = subtotal + deliveryCharges + gst;
    
    document.getElementById('deliveryCharges').textContent = deliveryCharges === 0 ? 'Free' : '₹' + deliveryCharges;
    document.getElementById('gst').textContent = '₹' + gst.toFixed(2);
    document.getElementById('totalAmount').textContent = '₹' + total.toFixed(2);
}

// Form submission
document.getElementById('checkoutForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate form
    if (!this.checkValidity()) {
        this.reportValidity();
        return;
    }
    
    // Collect form data
    const formData = new FormData(this);
    
    // Add delivery option
    const selectedDelivery = document.querySelector('input[name="delivery_option"]:checked');
    formData.append('delivery_option', selectedDelivery.value);
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
    submitBtn.disabled = true;
    
    // Submit order
    fetch('{% url "orders:checkout" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to payment or success page
            window.location.href = data.redirect_url || '/orders/payment/';
        } else {
            alert('Error processing order. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error processing order. Please try again.');
    })
    .finally(() => {
        // Reset button state
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateTotalAmount();
});
</script>
{% endblock %}