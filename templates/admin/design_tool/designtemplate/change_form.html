{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
    {{ block.super }}
    <style>
        /* Enhanced styling for the form */
        .field-tags input {
            width: 100%;
        }
        
        .tag-input-container {
            position: relative;
        }
        
        .tag-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .tag-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .tag-suggestion:hover {
            background-color: #f8f9fa;
        }
        
        .tag-suggestion.active {
            background-color: #007cba;
            color: white;
        }
        
        .product-types-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        
        .product-types-checkboxes label {
            display: flex;
            align-items: center;
            padding: 5px;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .product-types-checkboxes label:hover {
            background-color: #e9ecef;
        }
        
        .product-types-checkboxes input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .field-template_data textarea {
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            background-color: #f8f9fa;
            color: #495057;
        }
    </style>
{% endblock %}

{% block admin_change_form_document_ready %}
    {{ block.super }}
    <script>
    (function($) {
        // Enhanced tag input functionality
        const commonTags = [
            'business', 'professional', 'modern', 'clean', 'elegant', 'creative', 
            'minimal', 'corporate', 'vintage', 'colorful', 'simple', 'bold',
            'classic', 'contemporary', 'artistic', 'formal', 'casual', 'trendy'
        ];
        
        const tagInput = $('#id_tags');
        if (tagInput.length) {
            // Create suggestions container
            const container = $('<div class="tag-input-container"></div>');
            const suggestions = $('<div class="tag-suggestions"></div>');
            
            tagInput.wrap(container);
            tagInput.after(suggestions);
            
            let selectedIndex = -1;
            
            tagInput.on('input', function() {
                const value = $(this).val();
                const lastCommaIndex = value.lastIndexOf(',');
                const currentTag = value.slice(lastCommaIndex + 1).trim().toLowerCase();
                
                if (currentTag.length > 0) {
                    const matches = commonTags.filter(tag => 
                        tag.toLowerCase().includes(currentTag) && 
                        !value.toLowerCase().includes(tag.toLowerCase())
                    );
                    
                    if (matches.length > 0) {
                        suggestions.empty().show();
                        matches.forEach((tag, index) => {
                            const suggestion = $('<div class="tag-suggestion"></div>')
                                .text(tag)
                                .click(function() {
                                    insertTag(tag);
                                });
                            suggestions.append(suggestion);
                        });
                        selectedIndex = -1;
                    } else {
                        suggestions.hide();
                    }
                } else {
                    suggestions.hide();
                }
            });
            
            tagInput.on('keydown', function(e) {
                const suggestionItems = suggestions.find('.tag-suggestion');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, suggestionItems.length - 1);
                    updateSelection();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateSelection();
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    const selectedTag = suggestionItems.eq(selectedIndex).text();
                    insertTag(selectedTag);
                } else if (e.key === 'Escape') {
                    suggestions.hide();
                    selectedIndex = -1;
                }
            });
            
            function updateSelection() {
                const suggestionItems = suggestions.find('.tag-suggestion');
                suggestionItems.removeClass('active');
                if (selectedIndex >= 0) {
                    suggestionItems.eq(selectedIndex).addClass('active');
                }
            }
            
            function insertTag(tag) {
                const value = tagInput.val();
                const lastCommaIndex = value.lastIndexOf(',');
                const newValue = value.slice(0, lastCommaIndex + 1) + 
                    (lastCommaIndex >= 0 ? ' ' : '') + tag + ', ';
                tagInput.val(newValue);
                suggestions.hide();
                selectedIndex = -1;
                tagInput.focus();
            }
            
            // Hide suggestions when clicking outside
            $(document).click(function(e) {
                if (!$(e.target).closest('.tag-input-container').length) {
                    suggestions.hide();
                }
            });
        }
        
        // Add preview functionality for template_data
        const templateDataField = $('#id_template_data');
        if (templateDataField.length) {
            const previewBtn = $('<button type="button" class="button">Preview JSON</button>');
            templateDataField.after(previewBtn);
            
            previewBtn.click(function() {
                try {
                    const data = JSON.parse(templateDataField.val());
                    const formatted = JSON.stringify(data, null, 2);
                    templateDataField.val(formatted);
                } catch (e) {
                    alert('Invalid JSON format');
                }
            });
        }
        
        // Enhance product types selection with search
        const productTypesContainer = $('.field-product_types');
        if (productTypesContainer.length) {
            const searchInput = $('<input type="text" placeholder="Search products..." style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">');
            productTypesContainer.find('.product-types-checkboxes').before(searchInput);
            
            searchInput.on('input', function() {
                const searchTerm = $(this).val().toLowerCase();
                const labels = productTypesContainer.find('label');
                
                labels.each(function() {
                    const text = $(this).text().toLowerCase();
                    if (text.includes(searchTerm)) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });
        }
        
    })(django.jQuery);
    </script>
{% endblock %}